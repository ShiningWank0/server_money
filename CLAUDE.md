# Server Money - Claude AI アシスタント向け開発情報

## 注意
日本語で思考・回答・コメントアウトなどを行うこと

## プロジェクト概要

Server Moneyは、個人や小規模組織向けの高機能Web家計簿アプリケーションです。FlaskとVue.jsを使用したフルスタック構成で、複数口座の収支管理と可視化機能を提供します。

### 主要機能
- **セキュアな認証システム** - bcryptハッシュ化、セッション管理、ログイン試行制限
- **複数資金項目管理** - 現金・銀行口座・電子マネー等の柔軟な管理
- **インテリジェント収支管理** - 収入・支出の記録と残高自動計算
- **高度な検索・フィルタリング** - リアルタイム検索、複数項目選択、セッション永続化
- **包括的データ可視化** - 残高推移、収支比率、項目別分析、期間ナビゲーション
- **バックアップシステム** - CSVエクスポート、ログファイルダウンロード
- **統合ログ管理システム** - フロントエンド・バックエンド統合ログ、ローテーション、環境別設定

## 技術スタック

### バックエンド
- **Python 3.12+**
- **Flask 3.1+** - Webフレームワーク
- **SQLAlchemy 2.0+** - ORM
- **SQLite** - データベース
- **Waitress** - WSGIサーバー
- **bcrypt** - パスワードハッシュ化
- **python-dotenv** - 環境変数管理
- **uv** - パッケージマネージャー

### フロントエンド
- **Vue.js 3.0** - JavaScriptフレームワーク（本番ビルド使用）
- **Chart.js** - データ可視化ライブラリ（インタラクティブグラフ）
- **CSS3** - グラスモーフィズムデザイン、レスポンシブレイアウト
- **Material Icons** - Google Material Designアイコン
- **sessionStorage** - クライアントサイド状態永続化
- **SVGファビコン** - ブランディングと404エラー対策

## プロジェクト構造

```
server_money/
├── app.py                 # メインアプリケーション（簡素化済み）
├── auth_setup.py          # 初回認証セットアップスクリプト
├── models.py              # データベースモデル（SQLAlchemy）
├── auth.py                # 認証システム（bcryptハッシュ化、セッション管理）
├── config.py              # 設定管理（ログシステム、環境設定）
├── utils.py               # ユーティリティ関数（バックアップ、バリデーション）
├── routes/                # ルートパッケージ
│   ├── __init__.py        # パッケージ初期化
│   ├── auth_routes.py     # 認証関連ルート
│   ├── api_routes.py      # APIエンドポイント
│   └── main_routes.py     # メイン画面ルート
├── pyproject.toml         # プロジェクト設定・依存関係
├── .env.example           # 環境変数設定例
├── .gitignore            # Git除外設定（.env含む）
├── README.md             # 詳細ドキュメント
├── LICENSE               # MITライセンス
├── templates/
│   ├── index.html        # メインHTMLテンプレート
│   └── login.html        # ログイン画面
├── static/
│   ├── favicon.svg    # SVGファビコン（404エラー対策）
│   ├── css/
│   │   └── style.css     # グラスモーフィズムスタイル
│   └── js/
│       └── main.js       # Vue.jsアプリケーション
├── instance/
│   └── money_tracker.db  # SQLiteデータベース
├── logs/
│   └── money_tracker.log # アプリケーションログ
└── backups/              # CSVバックアップ
```

## 主要なデータベース

### Transactionテーブル
- `id`: 主キー
- `account`: 口座名（資金項目）
- `date`: 取引日時
- `item`: 取引項目名
- `type`: 取引種別（'income' or 'expense'）
- `amount`: 金額
- `balance`: 残高（自動計算）

## API エンドポイント

### 認証
- `GET /login` - ログイン画面
- `POST /api/login` - ログイン認証
- `POST /api/logout` - ログアウト
- `GET /api/auth_status` - 認証状態確認

### 取引管理（要認証）
- `GET /api/transactions` - 取引履歴取得（検索・フィルタ対応）
- `POST /api/transactions` - 新規取引追加
- `PUT /api/transactions/<id>` - 取引編集
- `DELETE /api/transactions/<id>` - 取引削除

### データ参照（要認証）
- `GET /api/accounts` - 口座一覧取得
- `GET /api/items` - 項目一覧取得
- `GET /api/balance_history` - 残高推移データ取得

### ユーティリティ（要認証）
- `GET /api/backup_csv` - CSVバックアップダウンロード
- `GET /api/download_log` - ログファイルダウンロード
- `POST /api/log` - フロントエンドからのログメッセージ受信

## 重要な設定

### 環境変数
- `LOGIN_USERNAME`: ログインID
- `LOGIN_PASSWORD_HASH`: bcryptハッシュ化されたパスワード
- `SECRET_KEY`: Flaskセッション暗号化キー
- `ENVIRONMENT`: 実行環境（development/production）
  - development: コンソール出力あり
  - production: ファイル出力のみ
- `LOG_LEVEL`: ログレベル（デフォルト: INFO）
  - DEBUG: 詳細なデバッグ情報（UI操作、セッション管理等）
  - INFO: 一般的な処理情報（データ取得、ユーザーアクション等）
  - WARNING: 警告レベル
  - ERROR: エラー情報
  - CRITICAL: 重大なエラー

### セットアップ・開発コマンド
```bash
# 初回認証設定（初回のみ）
uv run auth_setup.py

# 開発環境での実行（デフォルト: INFOレベル、コンソール出力あり）
ENVIRONMENT=development uv run app.py

# 本番環境での実行（デフォルト: INFOレベル、ファイル出力のみ）
ENVIRONMENT=production uv run app.py

# デバッグレベルでの実行（詳細ログ出力）
LOG_LEVEL=DEBUG uv run app.py

# カスタムログレベル指定での本番実行
ENVIRONMENT=production LOG_LEVEL=WARNING uv run app.py

# 依存関係の同期
uv sync
```

## 重要なファイル構成（モジュール化済み）

### app.py - メインアプリケーション
- **アプリケーションファクトリ** - create_app()関数でアプリ構成
- **Blueprint登録** - 機能別ルートの統合管理
- **起動シーケンス** - 初期化からサーバー起動までの制御

### models.py - データベースモデル
- **Transactionモデル** - SQLAlchemy ORMでのデータ構造定義
- **to_dict()メソッド** - JSONシリアライゼーション
- **データベースインスタンス** - dbオブジェクトの統一管理

### auth.py - 認証システム
- **パスワード検証** - bcryptハッシュ化と照合処理
- **ログイン試行制限** - IPアドレス別ロック機能
- **@login_requiredデコレータ** - エンドポイント保護
- **認証設定チェック** - .envファイルの存在検証

### config.py - 設定管理
- **Configクラス** - アプリケーション設定の一元管理
- **ログシステム設定** - 環境別ログ出力制御
- **ローテーション設定** - 10MBファイルサイズ、5ファイル保持

### utils.py - ユーティリティ関数
- **バックアップ管理** - 古いCSVファイルの自動削除
- **データベース初期化** - テーブル存在確認と作成
- **バリデーション** - 取引データの入力検証
- **日付解析** - 日付・時刻文字列のdatetime変換

### routes/ - ルートパッケージ
- **auth_routes.py** - ログイン、ログアウト、認証状態確認
- **api_routes.py** - 取引CRUD、データ分析、バックアップAPI
- **main_routes.py** - メイン画面表示

### auth_setup.py - 初回認証セットアップ
- **自動セットアップ** - ユーザー入力から.envファイル生成まで
- **パスワードハッシュ化** - bcryptでソルト付きハッシュ化
- **セキュアキー生成** - ランダムSECRET_KEYの作成
- **パスワード強度チェック** - 8文字以上の制限

### main.js の主要コンポーネント
- **Vue.jsリアクティブデータ管理** - 統合状態管理、computedプロパティ
- **API通信システム** - 非同期処理、エラーハンドリング、認証管理
- **セッション永続化機能** - sessionStorageでの資金項目選択状態保持
- **統一選択状態管理** - 全グラフ間での選択状態共有
- **高度なグラフ表示** - Chart.js統合、全画面表示、アスペクト比最適化
- **期間ナビゲーション** - 矢印ボタン、データ駆動境界検出、現在期間表示
- **インテリジェント検索** - リアルタイムフィルタリング、複数項目選択
- **モーダル管理** - z-index制御、オーバーレイ処理、アニメーション
- **セキュアログアウト** - セッション終了、状態クリア

### テンプレートファイルの特徴

#### login.html
- **グラスモーフィズムデザイン** - 半透明カード、backdrop-filter効果
- **リアルタイムバリデーション** - クライアントサイド入力検証
- **ログイン試行管理** - 残り回数表示、ロック状態アラート
- **スムーズアニメーション** - slideUp、shake、スピナー効果
- **ダークモード対応** - prefers-color-schemeメディアクエリ

#### index.html
- **Vue.js本番ビルド** - パフォーマンス最適化、コンソール警告削除
- **SVGファビコン** - 404エラー対策、オフライン環境対応
- **グラフモーダル** - 全画面表示、z-index制御、期間ナビゲーションUI
- **資金項目選択** - チェックボックスUI、状態表示、統一選択管理

#### style.css
- **グラスモーフィズムデザイン** - 半透明カード、グラデーション背景、ブラー効果
- **レスポンシブレイアウト** - flexbox、CSS Grid、メディアクエリ対応
- **モバイルファースト** - タッチフレンドリーボタン、スワイプ操作対応
- **Material Design準拠** - アイコン、カラーパレット、アニメーション
- **z-index管理** - レイヤー構造の適切な制御、モーダル表示最適化
- **カスタムコンポーネント** - チェックボックス、ドロップダウン、グラフモーダル

## 開発時の注意事項

### コード規約
- Python: PEP 8準拠
- JavaScript: ES6+標準
- 日本語コメントとログメッセージ
- 詳細なエラーハンドリング

### テスト・デバッグ
- 開発環境では詳細ログ出力
- ブラウザ開発者ツールでフロントエンド確認
- SQLiteデータベースの直接確認可能

### セキュリティ対策
- **bcryptパスワードハッシュ化** - ソルト付きハッシュ
- **セッション管理** - 2時間タイムアウト、セキュアクッキー
- **ログイン試行制限** - 5回失敗で30分ロック
- **環境変数保護** - .envファイルをGit管理から除外
- **認証必須化** - 全API エンドポイントに@login_required
- 入力値検証
- SQLインジェクション対策（SQLAlchemy ORM使用）
- 本番環境でのログ制限

## 開発タスクとベストプラクティス

### 新機能追加のワークフロー
1. **バックエンドAPI設計** - routes/パッケージ循用、認証デコレータ適用
2. **データベーススキーマ更新** - models.py経由、to_dict()メソッド更新
3. **フロントエンドUI実装** - Vue.jsコンポーネント化、リアクティブデータ活用
4. **スタイル統合** - グラスモーフィズムデザイン継承、z-index管理
5. **セッション状態管理** - sessionStorage活用、状態永続化考慮

### 最新の開発パターン
- **統一状態管理** - 複数コンポーネント間の選択状態共有
- **データ駆動UI** - 実データに基づいたナビゲーション制御
- **アスペクト比最適化** - Canvas要素の動的サイジング
- **パフォーマンス重視** - Vue.js本番ビルド、最小化CSS、非同期処理

### バグ修正
1. ログファイル確認（logs/money_tracker.log）
2. ブラウザ開発者ツール確認
3. データベース直接確認
4. 段階的デバッグ

### パフォーマンス最適化
- SQLクエリの最適化
- フロントエンドの仮想化
- 大量データ対応のページネーション
- 画像・CSS最適化

## 運用情報

### ログ管理
- **統合ログシステム**: フロントエンド・バックエンド統合（`/api/log`エンドポイント）
- **ファイルローテーション**: 10MB単位、5ファイル保持（`money_tracker.log` → `money_tracker.log.1-5`）
- **環境別出力制御**: development（コンソール+ファイル）、production（ファイルのみ）
- **コンポーネント別分類**: [JS:component], [Python:module] 形式でログソース識別
- **詳細ログ追跡**: API呼び出し、ユーザーアクション、データ操作、UI状態変化

### バックアップ
- CSVエクスポート機能
- 自動古ファイル削除（最新3件保持）
- SQLiteデータベースバックアップ

### 監視ポイント
- ディスク使用量（ログ・データベース）
- メモリ使用量
- API応答時間
- エラー発生率

## 最新の技術的改善点

### v1.0.3 - JSログ統合システム (2025年7月26日)
- **フロントエンド・バックエンド統合ログ** - console出力完全廃止、全ログを統一ファイルに集約
- **`/api/log`エンドポイント新設** - JS側からPythonログシステムへの直接送信
- **コンポーネント別ログ分類** - transactions/accounts/ui/session等の詳細カテゴリ分け
- **ユーザーアクション追跡** - ログイン、モーダル操作、資金項目選択等の完全ログ化
- **処理成功ログ強化** - データ取得、CRUD操作、バックアップ等の成功時ログ追加
- **デバッグログ体系化** - UI状態変化、セッションストレージ操作の詳細ログ

### v1.0.2 - フロントエンド・UI強化
- **Vue.js本番ビルド採用** - パフォーマンス向上、コンソール警告削除
- **sessionStorage活用** - 資金項目選択状態のクライアントサイド永続化
- **Canvas動的サイジング** - 円グラフの画面サイズ自動調整アルゴリズム
- **z-indexレイヤー管理** - ドロップダウンメニューの適切な表示層制御
- **期間ナビゲーション** - 矢印ボタン、現在期間表示、データ駆動境界検出
- **全画面表示** - グラフモーダルの大画面最適化
- **統一選択状態** - 全グラフ間での資金項目選択状態共有
- **SVGファビコン** - 404エラー対策、オフライン環境対応

## ライセンス

MIT License - 商用利用可能

---

*最終更新: 2025年7月26日 - v1.0.3 JSログ統合システム実装*